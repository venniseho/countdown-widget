<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Countdown Widget</title>
<style>
  :root{
    --bg:#f9f8fc;             
    --card:#bfaef5;           /* pastel purple main */
    --card-ink:#ffffff;
    --muted:#8c88a3;
    --ink:#1a102a;
    --accent:#d2c6fb;         /* light accent */
    --ring:rgba(191,174,245,.35); /* pastel ring */
    --radius:14px;
  }
  
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg);
    color:var(--ink);
    display:flex; align-items:center; justify-content:center;
  }
  .widget{
    width:min(560px, 92vw);
    background:#fff;
    border-radius:20px;
    box-shadow: 0 8px 24px rgba(21,16,55,.08);
    padding:18px 18px 22px;
    border:1px solid rgba(93,63,240,.08);
  }
  /* top bar */
  .top{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-bottom:14px;
  }
  .title-wrap{display:flex; align-items:center; gap:10px; min-height:36px}
  .emoji{font-size:22px}
  .title{
    font-size:20px; font-weight:700; letter-spacing:.2px;
  }
  .title-input{
    font-size:18px; padding:6px 10px; border-radius:10px; border:1px solid #e8e6f5; outline:none;
    box-shadow:0 0 0 0 transparent; width:220px;
  }
  .title-input:focus{border-color:var(--accent); box-shadow:0 0 0 6px var(--ring)}
  .icon-btn{
    display:inline-flex; align-items:center; justify-content:center;
    width:34px; height:34px; border:none; border-radius:10px;
    background:#fff; cursor:pointer; color:var(--muted);
    box-shadow: 0 0 0 1px #eee;
  }
  .icon-btn:hover{color:var(--accent); box-shadow:0 0 0 1px var(--accent)}
  .spacer{flex:1}

  /* countdown row */
  .row{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
  }
  .card{
    min-width:70px; padding:14px 10px; text-align:center;
    background:var(--card); color:var(--card-ink);
    border-radius:var(--radius);
  }
  .value{ font-weight:800; font-size:20px; line-height:1 }
  .label{ font-size:12px; opacity:.92; margin-top:6px; text-transform:uppercase; letter-spacing:.12em }

  .done{
    text-align:center; color:var(--muted); font-weight:600; padding:10px 0 2px;
  }

  /* modal */
  dialog{
    border:none; border-radius:16px; padding:18px; width:min(440px, 92vw);
    box-shadow: 0 20px 40px rgba(26,16,60,.18);
  }
  dialog::backdrop{background:rgba(15,10,30,.25)}
  .modal-title{font-weight:700; margin:2px 0 10px}
  .field{display:flex; flex-direction:column; gap:6px; margin:10px 0 14px}
  input[type="datetime-local"]{
    padding:10px 12px; border-radius:12px; border:1px solid #e7e4f6; outline:none;
    font-size:15px;
  }
  input[type="datetime-local"]:focus{border-color:var(--accent); box-shadow:0 0 0 6px var(--ring)}
  .modal-actions{display:flex; gap:8px; justify-content:flex-end; margin-top:6px}
  .btn{
    padding:10px 14px; border-radius:12px; border:1px solid #e7e4f6; background:#fff; cursor:pointer;
    font-weight:600;
  }
  .btn.primary{background:var(--card); color:#fff; border-color:var(--card)}
  .hint{color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="widget" id="widget">
    <div class="top">
      <div class="title-wrap">
        <div class="emoji" aria-hidden="true">üéâ</div>
        <div id="title" class="title">New Year</div>
        <input id="titleInput" class="title-input" style="display:none" />
        <button id="editTitle" class="icon-btn" title="Edit title" aria-label="Edit title">‚úèÔ∏é</button>
      </div>
      <div class="spacer"></div>
      <button id="openSettings" class="icon-btn" title="Edit date/time" aria-label="Edit date/time">‚öôÔ∏é</button>
    </div>

    <div class="row" id="cards" aria-live="polite" aria-atomic="true">
      <!-- cards injected here -->
    </div>
    <div id="done" class="done" style="display:none">Time's up üéØ</div>
  </div>

  <dialog id="settings">
    <div class="modal-title">Target date &amp; time</div>
    <div class="field">
      <label for="dt">When should we count down to?</label>
      <input id="dt" type="datetime-local" />
      <div class="hint">Uses your local timezone. Saved on this device.</div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="cancel">Cancel</button>
      <button class="btn primary" id="save">Save</button>
    </div>
  </dialog>

<script>
(function(){
  const STORAGE_KEY = "minimal-countdown-v1";
  const el = {
    title: document.getElementById('title'),
    titleInput: document.getElementById('titleInput'),
    editTitle: document.getElementById('editTitle'),
    openSettings: document.getElementById('openSettings'),
    settings: document.getElementById('settings'),
    dt: document.getElementById('dt'),
    save: document.getElementById('save'),
    cancel: document.getElementById('cancel'),
    cards: document.getElementById('cards'),
    done: document.getElementById('done'),
  };

  // --- state & load/save ---
  const defaults = {
    title: "New Year",
    // Default target: upcoming Jan 1 at 00:00
    targetISO: nextNewYearISO()
  };
  const state = load() || defaults;

  function nextNewYearISO(){
    const now = new Date();
    const year = now.getMonth() === 0 && now.getDate() === 1 ? now.getFullYear()+1 : now.getFullYear()+1;
    const d = new Date(year, 0, 1, 0, 0, 0);
    return toLocalDatetimeValue(d);
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(_){ return null; }
  }
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // --- title editing ---
  function enableTitleEdit(){
    el.titleInput.value = state.title || "";
    el.title.style.display = "none";
    el.titleInput.style.display = "inline-block";
    el.titleInput.focus();
    el.titleInput.select();
  }
  function commitTitle(){
    const v = el.titleInput.value.trim();
    state.title = v || "Countdown";
    el.title.textContent = state.title;
    el.title.style.display = "block";
    el.titleInput.style.display = "none";
    save();
  }
  el.editTitle.addEventListener('click', enableTitleEdit);
  el.title.addEventListener('click', enableTitleEdit);
  el.titleInput.addEventListener('keydown', e=>{
    if(e.key === 'Enter') commitTitle();
    if(e.key === 'Escape'){ el.titleInput.value = state.title; commitTitle(); }
  });
  el.titleInput.addEventListener('blur', commitTitle);

  // --- settings modal ---
  function toLocalDatetimeValue(date){
    const pad=n=>String(n).padStart(2,'0');
    // Local datetime-local expects "YYYY-MM-DDTHH:MM"
    return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }
  function fromLocalDatetimeValue(str){
    // Construct as local time
    const [d,t] = str.split('T');
    const [y,m,day] = d.split('-').map(Number);
    const [hh,mm] = (t||"00:00").split(':').map(Number);
    return new Date(y, (m||1)-1, day||1, hh||0, mm||0, 0, 0);
  }

  el.openSettings.addEventListener('click', ()=>{
    el.dt.value = state.targetISO || toLocalDatetimeValue(new Date());
    el.settings.showModal();
  });
  el.cancel.addEventListener('click', ()=> el.settings.close());
  el.save.addEventListener('click', ()=>{
    const v = el.dt.value;
    if(v){
      state.targetISO = v;
      save();
      el.settings.close();
      tick(); // update immediately
    }
  });

  // --- countdown math (months/days/hours/mins/secs) ---
  function diffParts(now, target){
    if(target <= now) return { months:0, days:0, hours:0, minutes:0, seconds:0, done:true };

    // months difference (calendar months)
    let months = (target.getFullYear() - now.getFullYear())*12 + (target.getMonth() - now.getMonth());
    // If target's day is less than current day, we haven't completed the month
    const tmp = new Date(now.getFullYear(), now.getMonth() + months, now.getDate(), now.getHours(), now.getMinutes(), now.getSeconds());
    if (tmp > target) months--;

    // subtract months from target to get remainder delta
    const afterMonths = new Date(now.getFullYear(), now.getMonth() + months, now.getDate(), now.getHours(), now.getMinutes(), now.getSeconds());
    let ms = target - afterMonths;
    if(ms < 0){ months--; ms = target - new Date(now.getFullYear(), now.getMonth() + months, now.getDate(), now.getHours(), now.getMinutes(), now.getSeconds()); }

    const sec = Math.floor(ms/1000);
    const days = Math.floor(sec / 86400);
    const hours = Math.floor((sec % 86400)/3600);
    const minutes = Math.floor((sec % 3600)/60);
    const seconds = Math.floor(sec % 60);

    return { months, days, hours, minutes, seconds, done:false };
  }

  // --- render ---
  function render(parts){
    el.cards.innerHTML = '';
    const units = [
      {k:'months', s:'m'},
      {k:'days', s:'d'},
      {k:'hours', s:'h'},
      {k:'minutes', s:'m'},
      {k:'seconds', s:'s'}
    ];
    units.forEach(u=>{
      const v = parts[u.k];
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<div class="value">${v}</div><div class="label">${u.s}</div>`;
      el.cards.appendChild(card);
    });
    el.done.style.display = parts.done ? 'block' : 'none';
  }

  function tick(){
    el.title.textContent = state.title;
    const target = fromLocalDatetimeValue(state.targetISO || toLocalDatetimeValue(new Date()));
    const now = new Date();
    const parts = diffParts(now, target);
    render(parts);
  }

  // --- boot ---
  tick();
  setInterval(tick, 1000);
})();
</script>
</body>
</html>
